#!/usr/bin/env bash
#
# ocdc-list - List devcontainer instances, clones, and sessions
#
# Shows a unified view of all workspaces: tracked containers, orphaned clones,
# and tmux sessions created by ocdc poll.
#
# Usage:
#   ocdc list           # List all instances, clones, and sessions
#   ocdc list --json    # Output as JSON
#   ocdc list --active  # Only show instances with running containers
#
# Related commands:
#   ocdc up      - Start devcontainer
#   ocdc down    - Stop devcontainer
#   ocdc go      - Navigate to clone
#   ocdc clean   - Clean up orphaned clones and sessions

set -euo pipefail

# Source paths library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/ocdc-paths.bash"
source "${SCRIPT_DIR}/ocdc-sessions.bash"

CACHE_DIR="$OCDC_CACHE_DIR"
PORTS_FILE="$OCDC_PORTS_FILE"
CLONES_DIR="$OCDC_CLONES_DIR"

# Parse arguments
JSON_OUTPUT=false
ACTIVE_ONLY=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --json|-j)
      JSON_OUTPUT=true
      shift
      ;;
    --active|-a)
      ACTIVE_ONLY=true
      shift
      ;;
    --help|-h)
      sed -n '2,/^$/p' "$0" | sed 's/^# //' | sed 's/^#//'
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
  esac
done

# Check if port is actually in use
is_port_active() {
  lsof -i ":$1" >/dev/null 2>&1
}

# Get tracked workspaces
get_tracked_workspaces() {
  if [[ -f "$PORTS_FILE" ]]; then
    jq -r 'keys[]' "$PORTS_FILE" 2>/dev/null || true
  fi
}

# Get workspaces that have active sessions
get_session_workspaces() {
  local session_name poll_config workspace
  while IFS= read -r session_name; do
    [[ -z "$session_name" ]] && continue
    poll_config=$(tmux show-environment -t "$session_name" 2>/dev/null | grep '^OCDC_POLL_CONFIG=' | cut -d= -f2- || true)
    [[ -z "$poll_config" ]] && continue
    
    workspace=$(tmux show-environment -t "$session_name" 2>/dev/null | grep '^OCDC_WORKSPACE=' | cut -d= -f2- || true)
    [[ -n "$workspace" ]] && echo "$workspace"
  done < <(tmux list-sessions -F '#{session_name}' 2>/dev/null)
}

# Format git status for display
format_git_status() {
  local workspace="$1"
  local git_info
  git_info=$(ocdc_get_git_status "$workspace" 2>/dev/null || echo '{"clean":true,"pushed":true,"ahead":0}')
  
  local clean pushed ahead
  clean=$(echo "$git_info" | jq -r '.clean')
  pushed=$(echo "$git_info" | jq -r '.pushed')
  ahead=$(echo "$git_info" | jq -r '.ahead')
  
  if [[ "$clean" == "false" ]]; then
    echo "dirty"
  elif [[ "$pushed" == "false" ]]; then
    echo "clean ↑$ahead"
  else
    echo "clean"
  fi
}

# Get current workspace for highlighting (resolve symlinks for consistent comparison)
CURRENT_WS=""
if git rev-parse --git-dir >/dev/null 2>&1; then
  CURRENT_WS=$(ocdc_resolve_path "$(git rev-parse --show-toplevel 2>/dev/null || pwd)")
fi

# JSON output
output_json() {
  local result="[]"
  local tracked_ws session_ws
  tracked_ws=$(get_tracked_workspaces)
  session_ws=$(get_session_workspaces)
  
  # Add tracked containers
  if [[ -f "$PORTS_FILE" ]]; then
    local port repo branch workspace status git_status entry
    while IFS=$'\t' read -r port repo branch workspace; do
      [[ -n "$port" ]] || continue
      
      status="down"
      is_port_active "$port" && status="up"
      
      git_status=$(ocdc_get_git_status "$workspace" 2>/dev/null || echo '{"clean":true,"pushed":true,"ahead":0,"is_git":false}')
      
      entry=$(jq -n \
        --arg type "container" \
        --arg workspace "$workspace" \
        --argjson port "$port" \
        --arg repo "$repo" \
        --arg branch "$branch" \
        --arg status "$status" \
        --argjson git "$git_status" \
        '{type: $type, workspace: $workspace, port: $port, repo: $repo, branch: $branch, status: $status, git: $git}')
      
      result=$(echo "$result" "[$entry]" | jq -s 'add')
    done < <(jq -r 'to_entries[] | "\(.value.port)\t\(.value.repo)\t\(.value.branch)\t\(.key)"' "$PORTS_FILE" 2>/dev/null)
  fi
  
  # Add sessions (that aren't already tracked as containers)
  if [[ "$ACTIVE_ONLY" != "true" ]]; then
    local session_name poll_config workspace branch item_key repo status git_status entry
    while IFS= read -r session_name; do
      [[ -z "$session_name" ]] && continue
      
      poll_config=$(tmux show-environment -t "$session_name" 2>/dev/null | grep '^OCDC_POLL_CONFIG=' | cut -d= -f2- || true)
      [[ -z "$poll_config" ]] && continue
      
      workspace=$(tmux show-environment -t "$session_name" 2>/dev/null | grep '^OCDC_WORKSPACE=' | cut -d= -f2- || true)
      branch=$(tmux show-environment -t "$session_name" 2>/dev/null | grep '^OCDC_BRANCH=' | cut -d= -f2- || true)
      item_key=$(tmux show-environment -t "$session_name" 2>/dev/null | grep '^OCDC_ITEM_KEY=' | cut -d= -f2- || true)
      
      # Skip if this workspace is already tracked as a container
      if echo "$tracked_ws" | grep -qFx "$workspace" 2>/dev/null; then
        continue
      fi
      
      repo=""
      if [[ -n "$workspace" ]]; then
        repo=$(basename "$(dirname "$workspace")")
      fi
      
      status="session"
      [[ ! -d "$workspace" ]] && status="orphan"
      
      git_status='{"clean":true,"pushed":true,"ahead":0,"is_git":false}'
      if [[ -d "$workspace" ]]; then
        git_status=$(ocdc_get_git_status "$workspace" 2>/dev/null || echo "$git_status")
      fi
      
      entry=$(jq -n \
        --arg type "session" \
        --arg workspace "$workspace" \
        --arg session "$session_name" \
        --arg repo "$repo" \
        --arg branch "$branch" \
        --arg status "$status" \
        --arg poll_config "$poll_config" \
        --arg item_key "$item_key" \
        --argjson git "$git_status" \
        '{type: $type, workspace: $workspace, session: $session, port: null, repo: $repo, branch: $branch, status: $status, poll_config: $poll_config, item_key: $item_key, git: $git}')
      
      result=$(echo "$result" "[$entry]" | jq -s 'add')
    done < <(tmux list-sessions -F '#{session_name}' 2>/dev/null)
  fi
  
  # Add orphaned clones (that aren't tracked and don't have sessions)
  if [[ -d "$CLONES_DIR" ]] && [[ "$ACTIVE_ONLY" != "true" ]]; then
    local repo_dir repo_name clone_dir branch_name git_status entry
    for repo_dir in "$CLONES_DIR"/*/; do
      [[ -d "$repo_dir" ]] || continue
      repo_name=$(basename "$repo_dir")
      
      for clone_dir in "$repo_dir"*/; do
        [[ -d "$clone_dir" ]] || continue
        clone_dir="${clone_dir%/}"
        
        # Skip if tracked as container
        if echo "$tracked_ws" | grep -qFx "$clone_dir" 2>/dev/null; then
          continue
        fi
        
        # Skip if has a session
        if echo "$session_ws" | grep -qFx "$clone_dir" 2>/dev/null; then
          continue
        fi
        
        branch_name=$(basename "$clone_dir")
        git_status=$(ocdc_get_git_status "$clone_dir" 2>/dev/null || echo '{"clean":true,"pushed":true,"ahead":0,"is_git":false}')
        
        entry=$(jq -n \
          --arg type "orphan" \
          --arg workspace "$clone_dir" \
          --arg repo "$repo_name" \
          --arg branch "$branch_name" \
          --argjson git "$git_status" \
          '{type: $type, workspace: $workspace, port: null, repo: $repo, branch: $branch, status: "orphan", git: $git}')
        
        result=$(echo "$result" "[$entry]" | jq -s 'add')
      done
    done
  fi
  
  echo "$result"
}

# Table output
output_table() {
  local has_output=false
  local tracked_ws session_ws
  tracked_ws=$(get_tracked_workspaces)
  session_ws=$(get_session_workspaces)
  
  # Collect all items into arrays for unified display
  declare -a PORTS=()
  declare -a REPOS=()
  declare -a BRANCHES=()
  declare -a STATUSES=()
  declare -a WORKSPACES=()
  declare -a GIT_STATUSES=()
  declare -a SESSIONS=()
  
  # Add tracked containers
  if [[ -f "$PORTS_FILE" ]] && [[ $(jq 'length' "$PORTS_FILE" 2>/dev/null || echo 0) -gt 0 ]]; then
    local port repo branch workspace status git_display
    while IFS=$'\t' read -r port repo branch workspace; do
      [[ -n "$port" ]] || continue
      
      if is_port_active "$port"; then
        status="UP"
      else
        status="DOWN"
      fi
      
      # Skip if filtering for active only
      if [[ "$ACTIVE_ONLY" == "true" ]] && [[ "$status" != "UP" ]]; then
        continue
      fi
      
      git_display=$(format_git_status "$workspace")
      
      PORTS+=("$port")
      REPOS+=("$repo")
      BRANCHES+=("$branch")
      STATUSES+=("$status")
      WORKSPACES+=("$workspace")
      GIT_STATUSES+=("$git_display")
      SESSIONS+=("")
    done < <(jq -r 'to_entries[] | "\(.value.port)\t\(.value.repo)\t\(.value.branch)\t\(.key)"' "$PORTS_FILE" 2>/dev/null)
  fi
  
  # Add sessions (that aren't already tracked as containers)
  if [[ "$ACTIVE_ONLY" != "true" ]]; then
    local session_name poll_config workspace branch repo status git_display
    while IFS= read -r session_name; do
      [[ -z "$session_name" ]] && continue
      
      poll_config=$(tmux show-environment -t "$session_name" 2>/dev/null | grep '^OCDC_POLL_CONFIG=' | cut -d= -f2- || true)
      [[ -z "$poll_config" ]] && continue
      
      workspace=$(tmux show-environment -t "$session_name" 2>/dev/null | grep '^OCDC_WORKSPACE=' | cut -d= -f2- || true)
      branch=$(tmux show-environment -t "$session_name" 2>/dev/null | grep '^OCDC_BRANCH=' | cut -d= -f2- || true)
      
      # Skip if this workspace is already tracked as a container
      if echo "$tracked_ws" | grep -qFx "$workspace" 2>/dev/null; then
        continue
      fi
      
      repo=""
      if [[ -n "$workspace" ]]; then
        repo=$(basename "$(dirname "$workspace")")
      fi
      
      status="SESSION"
      git_display="-"
      
      if [[ ! -d "$workspace" ]]; then
        status="ORPHAN"
      else
        git_display=$(format_git_status "$workspace")
      fi
      
      PORTS+=("-")
      REPOS+=("$repo")
      BRANCHES+=("$branch")
      STATUSES+=("$status")
      WORKSPACES+=("$workspace")
      GIT_STATUSES+=("$git_display")
      SESSIONS+=("$session_name")
    done < <(tmux list-sessions -F '#{session_name}' 2>/dev/null)
  fi
  
  # Add orphaned clones (that aren't tracked and don't have sessions)
  if [[ -d "$CLONES_DIR" ]] && [[ "$ACTIVE_ONLY" != "true" ]]; then
    local repo_dir repo_name clone_dir branch_name git_display
    for repo_dir in "$CLONES_DIR"/*/; do
      [[ -d "$repo_dir" ]] || continue
      repo_name=$(basename "$repo_dir")
      
      for clone_dir in "$repo_dir"*/; do
        [[ -d "$clone_dir" ]] || continue
        clone_dir="${clone_dir%/}"
        
        # Skip if tracked as container
        if echo "$tracked_ws" | grep -qFx "$clone_dir" 2>/dev/null; then
          continue
        fi
        
        # Skip if has a session
        if echo "$session_ws" | grep -qFx "$clone_dir" 2>/dev/null; then
          continue
        fi
        
        branch_name=$(basename "$clone_dir")
        git_display=$(format_git_status "$clone_dir")
        
        PORTS+=("-")
        REPOS+=("$repo_name")
        BRANCHES+=("$branch_name")
        STATUSES+=("ORPHAN")
        WORKSPACES+=("$clone_dir")
        GIT_STATUSES+=("$git_display")
        SESSIONS+=("")
      done
    done
  fi
  
  # Display unified table
  if [[ ${#PORTS[@]} -gt 0 ]]; then
    echo ""
    printf "%-6s  %-20s  %-16s  %-8s  %-10s  %s\n" "PORT" "REPO" "BRANCH" "STATUS" "GIT" "SESSION/PATH"
    printf "%-6s  %-20s  %-16s  %-8s  %-10s  %s\n" "──────" "────────────────────" "────────────────" "────────" "──────────" "────────────"
    
    local i port repo branch status workspace git_status session
    for i in "${!PORTS[@]}"; do
      port="${PORTS[$i]}"
      repo="${REPOS[$i]}"
      branch="${BRANCHES[$i]}"
      status="${STATUSES[$i]}"
      workspace="${WORKSPACES[$i]}"
      git_status="${GIT_STATUSES[$i]}"
      session="${SESSIONS[$i]}"
      
      # Truncate long values
      [[ ${#repo} -gt 20 ]] && repo="${repo:0:17}..."
      [[ ${#branch} -gt 16 ]] && branch="${branch:0:13}..."
      
      # Color for status
      local status_display=""
      case "$status" in
        UP)      status_display="\033[32mUP\033[0m      " ;;
        DOWN)    status_display="\033[31mDOWN\033[0m    " ;;
        SESSION) status_display="\033[34mSESSION\033[0m " ;;
        ORPHAN)  status_display="\033[33mORPHAN\033[0m  " ;;
      esac
      
      # Color for git status
      local git_display=""
      case "$git_status" in
        dirty)    git_display="\033[31mdirty\033[0m     " ;;
        clean\ *) git_display="\033[33m${git_status}\033[0m" ;;
        clean)    git_display="\033[32mclean\033[0m     " ;;
        -)        git_display="-         " ;;
      esac
      
      # Pad git display to 10 chars
      local git_len=${#git_status}
      local padding=$((10 - git_len))
      [[ $padding -gt 0 ]] && git_display="${git_display}$(printf '%*s' $padding '')"
      
      # Show session name or truncated path
      local extra=""
      if [[ -n "$session" ]]; then
        extra="$session"
      else
        if [[ ${#workspace} -gt 30 ]]; then
          extra="...${workspace: -27}"
        else
          extra="$workspace"
        fi
      fi
      
      # Highlight current workspace
      local marker=""
      if [[ "$workspace" == "$CURRENT_WS" ]]; then
        marker="* "
      fi
      
      printf "%-6s  %-20s  %-16s  ${status_display}${git_display}  %s%s\n" \
        "$port" "$repo" "$branch" "$marker" "$extra"
    done
    has_output=true
  fi
  
  if [[ "$has_output" != "true" ]]; then
    echo "No devcontainer instances, clones, or sessions found."
    exit 0
  fi
  
  echo ""
  echo "* = current directory"
  echo ""
  echo "Commands:"
  echo "  ocdc go <branch>       Navigate to clone"
  echo "  ocdc exec <cmd>        Execute command in container"
  echo "  ocdc down              Stop current container"
  echo "  ocdc clean             Clean up orphans (clones + sessions)"
  echo "  ocdc tui               Interactive TUI"
}

# Main
if [[ "$JSON_OUTPUT" == "true" ]]; then
  output_json
else
  output_table
fi
